# V2 新架構中文說明

**文件版本**: 1.0
**更新日期**: 2025-06-17

這份文件旨在用更易於理解的方式，說明本次系統從 v1 升級到 v2 的核心架構變化。

## 1. 為什麼要重構？ (The "Why")

我們原本的系統，所有功能都集中在 `DailyReport.js` 這一個檔案裡。隨著功能越來越多，它變得像一個什麼都賣的「巨型雜貨店」，產生了許多問題 (也就是 `issues.md` 中提到的)：

- **難以維護 (Issue #001)**: 將近 600 行的程式碼擠在一起，想修改一個小功能，就像在倉庫裡找一個特定的螺絲，非常困難且容易改錯地方。
- **缺乏彈性 (Issue #002, #004, #005)**: 無論是 Google Sheet 的欄位名稱、或是報告輸出的格式，都寫死在程式碼裡。每次調整，都像在進行一場大型手術。
- **擴展性差 (Issue #006)**: 想換一種分數計算方式，或是接入另一個 AI 模型，都得重寫大部分的程式碼。

**簡單來說，舊架構就像把所有雞蛋放在同一個籃子裡，不僅沉重，而且風險很高。**

## 2. 新架構的核心理念：專業分工的「工作室團隊」

為了徹底解決上述問題，我們引入了「微服務 (Microservices)」和「事件驅動 (Event-Driven)」這兩個現代軟體設計的核心理念。

您可以想像我們把原本那間「巨型雜貨店」，改造成一個由各領域專家組成的「工作室團隊」：

- **微服務 (Microservices)**: 團隊裡每個人都有非常明確的專業分工。有人專門負責讀寫表格、有人專門負責計算分數、有人專門負責發送郵件。每個人都只做自己最擅長的事，互不干擾。
- **事件驅動 (Event-Driven)**: 團隊成員之間不直接對話，而是透過一個「中央訊息板 (EventBus)」來溝通。當一位成員完成工作後，他會去訊息板上貼一張「任務完成」的便條，關聯的下一位成員看到後，就知道輪到自己開工了。

這種模式帶來的好處是 **「高內聚，低耦合」**：每個服務內部功能緊密，但服務之間依賴性極低。

## 3. 我們的「工作室團隊」成員介紹 (新服務說明)

以下是我們團隊中各個新服務（`.js` 檔案）的角色定位：

- **`ReportOrchestrator.js` (專案經理)**
  - **職責**: 整個報告生成流程的總指揮。他會發起第一個任務，並在收到最終「任務完成」的訊息後，宣告工作結束。他不處理實際工作，只負責協調。

- **`EventBus.js` (中央訊息板)**
  - **職責**: 團隊的溝通中心。所有服務都透過它來發布事件 (貼便條) 和監聽事件 (看便條)。

- **`SheetAdapter.js` & `SchemaService.js` (數據管理員團隊)**
  - **`SchemaService.js`**: 他拿著一本「欄位對照表」，負責定義 Google Sheet 的所有欄位名稱和版本。解決了欄位寫死的問題。
  - **`SheetAdapter.js`**: 他是唯一被允許接觸 Google Sheet 的人。所有讀取、寫入操作都由他根據「欄位對照表」來執行。

- **`ScoreCalculatorFactory.js` (計分專家)**
  - **職責**: 負責所有分數的計算。他內部可以管理「多個版本」的計分模型（例如 v1, v2 演算法），並能輕鬆切換。這解決了計分方式難以調整的問題。

- **`PromptBuilderService.js` (AI 溝通專家)**
  - **職責**: 專門負責組合要發送給 AI 的「指令 (Prompt)」。他有各種模板，可以根據數據和分數，產生結構最完整、效果最好的指令。

- **`ApiService.js` (外交官)**
  - **職責**: 專門負責與外部 AI 平台 (如 DeepSeek) 溝通。未來如果想換成別家的 AI，甚至本地的模型，只需要調整這位外交官，其他成員完全不受影響。

- **`EmailService.js` (郵件專家)**
  - **職責**: 專門負責產生精美的 HTML 郵件並發送。他有自己的郵件模板和樣式。

- **`Main.js` (總機 / 接待員)**
  - **職責**: 系統的統一入口。無論是您手動執行，還是 Google 的定時觸發器，都只會接觸到這個檔案。它負責接待「指令」，然後轉交給「專案經理 (`ReportOrchestrator`)」。

- **`DailyReport.js` (已退休的元老)**
  - **職責**: 這是舊的檔案，我們暫時保留它，以確保在新舊系統切換期間，若有問題可以立刻退回舊版，確保系統穩定。

## 4. 新的工作流程是怎麼樣的？

當一個每日報告任務開始時，流程如下：

1.  **接待員 (`Main.js`)** 接到指令，通知 **專案經理 (`ReportOrchestrator`)** 開工。
2.  **專案經理** 在 **中央訊息板 (`EventBus`)** 上貼出第一張便條：「報告生成任務開始！」
3.  **數據管理員 (`SheetAdapter`)** 看到便條，立刻去 Google Sheet 讀取今天的資料，完成後去訊息板貼上：「資料讀取完畢！」並附上資料。
4.  **計分專家 (`ScoreCalculatorFactory`)** 看到新便條，拿走資料，計算好分數，然後去訊息板貼上：「分數計算完畢！」並附上分數。
5.  **AI 溝通專家 (`PromptBuilderService`)** 接手，根據資料和分數，寫好給 AI 的指令，然後貼上：「AI 指令已就緒！」
6.  **外交官 (`ApiService`)** 出動，將指令發送給 AI，拿到分析結果後，貼上：「AI 分析已完成！」並附上結果。
7.  **數據管理員** 再次出動，看到分析結果，將其寫回 Google Sheet，然後貼上：「報告已儲存！」
8.  **郵件專家 (`EmailService`)** 看到報告已儲存，立刻產生郵件並發送，然後貼上：「郵件已寄出！」
9.  **專案經理** 看到「郵件已寄出」的最終便條，向 **接待員** 報告：「今日所有工作順利完成！」
10. 流程結束。

## 5. 新架構帶來的好處

- **完全解決現有問題**: 上述提到的 `issues.md` 中的所有 6 個問題，都透過對應的服務（`SchemaService`, `ScoreCalculatorFactory` 等）得到了徹底解決。
- **可維護性極高**: 想修改郵件樣式？只需要去改 `EmailService.js`，完全不用擔心影響其他部分。
- **除錯更容易**: `Main.js` 中提供了 `viewEventHistory()` 函式，可以清楚地看到每一步的執行紀錄，哪裡出錯一目了然。
- **擴展性超強**:
  - 想增加「週報」功能？只需要新增一個 `WeeklyReportOrchestrator`，並複用現有的大部分服務即可。
  - AI 模型想換一家？改 `ApiService.js` 就好。
  - 計分方式想升級？在 `ScoreCalculatorFactory.js` 裡增加一個 v2 版本即可。

總之，我們現在擁有一個更強大、更靈活、也更容易維護的系統。希望這份說明能幫助您理解這次重構的核心價值！ 